<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>「网络代理」这件小事 | Tai's Blog</title><meta name=keywords content="折腾,自定义,代理,Mihomo"><meta name=description content="引子 代理，对于很多人来说并不陌生，尤其是在科研领域，例如在谷歌学术上查找论文的 BibTeX 时。然而，我们常常对网络代理的原理、功能以及如何更好地配置等"><meta name=author content><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="eAKh7zszsOtNde1wyq_sUo95ZPH4zTTJhR-_ol4VWDs"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://yunpengtai.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://yunpengtai.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://yunpengtai.top/favicon-32x32.png><link rel=apple-touch-icon href=http://yunpengtai.top/apple-touch-icon.png><link rel=mask-icon href=http://yunpengtai.top/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-Y3CX2RWEDY"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Y3CX2RWEDY",{anonymize_ip:!1})}</script><meta property="og:title" content="「网络代理」这件小事"><meta property="og:description" content="引子 代理，对于很多人来说并不陌生，尤其是在科研领域，例如在谷歌学术上查找论文的 BibTeX 时。然而，我们常常对网络代理的原理、功能以及如何更好地配置等"><meta property="og:type" content="article"><meta property="og:url" content="http://yunpengtai.top/posts/know-mihomo/"><meta property="og:image" content="http://yunpengtai.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-29T14:38:00+08:00"><meta property="article:modified_time" content="2025-01-07T17:10:00+08:00"><meta property="og:site_name" content="Tai's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://yunpengtai.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="「网络代理」这件小事"><meta name=twitter:description content="引子 代理，对于很多人来说并不陌生，尤其是在科研领域，例如在谷歌学术上查找论文的 BibTeX 时。然而，我们常常对网络代理的原理、功能以及如何更好地配置等"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"http://yunpengtai.top/posts/"},{"@type":"ListItem","position":3,"name":"「网络代理」这件小事","item":"http://yunpengtai.top/posts/know-mihomo/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"「网络代理」这件小事","name":"「网络代理」这件小事","description":"引子 代理，对于很多人来说并不陌生，尤其是在科研领域，例如在谷歌学术上查找论文的 BibTeX 时。然而，我们常常对网络代理的原理、功能以及如何更好地配置等","keywords":["折腾","自定义","代理","Mihomo"],"articleBody":"引子 代理，对于很多人来说并不陌生，尤其是在科研领域，例如在谷歌学术上查找论文的 BibTeX 时。然而，我们常常对网络代理的原理、功能以及如何更好地配置等问题缺乏深入了解。这其实是不可取的，因为网络代理已经深入到我们生活的方方面面，因此，我们更应该去理解它，并让它更好地为我们服务。\n然而，网上关于代理具体原理的解释却相对匮乏，大多是零星片段，甚至存在互相矛盾之处。官方文档也往往仅限于对某些具体配置的说明。为此，笔者投入了大量精力，广泛阅读了各类文献和相关博客，力求去芜存菁，汇聚成本文。对于部分文献未涉及之处，笔者结合自身理解进行了补充，但囿于水平，恐有疏漏。若读者能及时指出，笔者将不胜感激！\n请注意，本文只讨论计算机网络中的各种原理，若读者将此用于违法之事，读者应个人承担相应责任，与本文和作者无关！\n客户端 在展开对具体技术细节的讨论之前，我们先来聊聊「客户端」的选择，因为客户端的些许不同，会导致支持的功能也会存在差异。这里我主要介绍我正在用的几款开源软件，读者可以根据需要进行取舍\n本章只会介绍电脑端以及移动端，至于其他的如路由器等，请读者自行查阅资料\n电脑端 我个人是在使用 Windows 11 23H2，不过读者不必担心自己是 MacOS 抑或是 Linux，我用的软件是多端适配~\n我早期用的软件是 Clash for Windows（CFW），后面 CFW 因为一些不可抗力原因呢就停止了维护，我就去寻找了其他的软件，用过 Clash Verge 一段时间，后面这个也停止维护了，然后目前是有人接力了 Verge 继续开发，叫 Clash Verge Rev，目前我也一直在用，软件也在积极更新中~\nUI 还不错，而且最关键的是内置了 Clash Meta（Mihomo）内核，对于小白来说，可以这样理解：内核实现了诸多复杂的功能，比如自定义一些域名的代理，比如浏览 google.com 用香港的节点，目前 Mihomo 也是社区中维护最为频繁而且功能也好用的内核 附上社区中支持 Mihomo 的软件清单供读者参考，本文只会介绍我用过的软件\n有些读者可能在用，或者考虑用 Mihomo Party，我个人使用过一段时间，并不推荐，尤其是对于自己写覆写配置的人来说，因为它这个软件很多地方压根不遵循你的配置，比如关于 geodata 的地址，更新频率，甚至你明明在配置里写明 DNS 支持 IPv6，然而你点开正在运行的配置，IPv6 还是 false，有很多地方你都得手动去 check，不建议使用，而上面的 clash verge rev 基本都遵循你的覆写配置，我目前检查下来只有总的 IPv6 控制需要额外去软件设置\n移动端 我个人用的是 Android 手机，安卓端一开始我用的是 Clash Meta for Android，也是支持 Mihomo 内核的。然而发现这款软件用途有些局限，手机流量连接时开代理没法访问我的纯 IPv6 服务器，即使配置和软件覆写中 IPv6 全开的情况（解决方案可以看本文的开代理访问IPv6），寻找解决方案时发现另一款软件叫 FlClash， 不仅能够解决我这个问题，UI 支持 material you 以及配置中的图标，就很好看；同时可定义的配置更多\n说完了 Android，我还有一台 iPad，目前是在用 sing-box和 Shadowsocket，后者自不必多说，比较简单的代理软件，前者也在用的原因是其免费，同时也支持比较复杂的功能，比如 AdGuard DNS Filter，当然读者如果已经购买了 Surge 等软件，可以继续沿用~\n当你访问时 接下来讨论一些更有趣的，本章会详细介绍客户端向你的代理软件发起请求时，Mihomo 内核的 DNS 工作流程，比如浏览器访问某个网页\n如果一开始客户端访问的就是 IP，就不用费很多事，直接到关于 IP 的规则，比如是直连还是走代理等，不需要域名解析。下面是一个简单的 IP 规则举例，CIDR 表示 IP 的范围\nrules: # 以 192.168.1.0 开始的 IP 段 - IP-CIDR,192.168.1.0/23,DIRECT # 走直连 - IP-CIDR,103.151.150.0/23,香港-代理 # 走香港-代理 走代理的意思是说，代理软件将访问的请求发送给你的代理节点（这里就是香港的服务器），然后代理节点将访问接收到的 IP 或者域名，最后代理节点会把响应返回给代理软件；走直连的意思是直接和该 IP 进行连接\n而对于域名的访问就要复杂一些，故而接下来将详细讨论客户端向某个域名发起请求会具体发生什么，为了让概念更加清晰易懂，下面的流程图中省略了 IP 规则的部分 部分参考自 Mihomo 官方文档\nflowchart TB Start[客户端发起请求] --\u003e fake[fake-ip 反查] fake[fake-ip 反查] --\u003e Domain[基于域名匹配规则] fake --\u003e |fakeip-filter|system[系统解析 DNS] Domain --\u003e |匹配过程中|IP[遇到 IP 规则] Domain --\u003e reject[匹配到 Reject 规则] Domain --\u003e |匹配到直连规则|Cache IP --\u003e Cache Domain --\u003e |匹配到代理规则|Remote[通过代理服务器解析域名并建立连接] Cache --\u003e |Cache 未命中|NS[匹配 nameserver-policy 并查询 ] Cache --\u003e |Cache 命中|Get NS --\u003e |匹配成功| Get[将查询到的 IP 用于匹配 IP 规则] NS --\u003e |没匹配到| NF[nameserver/fallback 并发查询] NF --\u003e Get[查询得到 IP] Get --\u003e |缓存 DNS 结果|Cache[(查询 DNS 缓存)] 确定域名前 在讲具体的域名规则之前，我们还得确保一件事：就是你的代理软件得知道你访问的「目标域名」，听起来是不是有点意外。有时候代理软件不知道你访问的目标域名是什么，比如以下情况：\n假设你的浏览器没有直接通过代理协议（如 socks5 或 http 代理）将请求发送到代理软件，而是依赖系统的普通网络栈。在这种情况下，浏览器会向系统发起域名解析，操作系统会通过本地的 DNS 服务器将域名解析为 IP 地址。然后，浏览器使用这个 IP 地址建立连接。这种场景下，浏览器完全没有直接传递域名给代理，代理只知道「一个 IP 地址」\n那这个时候很有可能就会有问题，因为代理压根不知道你访问的是哪个域名：故而需要引入一个新的机制：fake-ip 因为 redir-host 已经过时了，故本文并不会进行讨论\nfake-ip 的定义出自 RFC3089，关于 fake-ip 的介绍，Clash 知识库介绍的很好，我这里摘抄一下：\nfake-ip 池的默认 CIDR 是 198.18.0.1/16，一个保留的 IPv4 地址空间（CIDR 表示的是一个 IP 范围）\n当 DNS 请求被发送到 Clash DNS 时，Clash 内核会通过管理内部的域名和其 fake-ip 地址的映射，从池中分配一个空闲的 fake-ip 地址\n以使用浏览器访问 https://google.com 为例\n浏览器向 Clash DNS 请求 google.com 的 IP 地址 Clash 检查内部映射并返回 198.18.1.5 浏览器向 198.18.1.5 的 80/tcp 端口发送 HTTP 请求 当收到 198.18.1.5 的入站数据包时，Clash 查询内部映射，发现客户端实际上是在向 google.com 发送数据包 a. Clash 可能仅将域名发送到 SOCKS5 或 shadowsocks 等出站代理，并与代理服务器建立连接；b. 或者 Clash 可能会基于 SCRIPT、GEOIP、IP-CIDR 规则或者使用 DIRECT 直连出口查询 google.com 的真实 IP 地址 我总结一下：简而言之，fake-ip 通过拦截客户端的解析请求从而知道真正需要访问的域名是什么，进而可以使用提前设置的分流规则\n当然，你可能会疑惑，我明明都输入了 google.com 了，为什么还要「多此一举」呢？尽管大多数时候客户端的请求中都指明了访问的域名，但有些时候并不能直接获得域名，所以得都拦截下来，以确保代理知道你要访问的域名\n刚刚我们也说过会有系统接管 DNS 解析的情况，有些我们并不需要通过代理软件进行解析，比如访问 localhost:8080 这种本地的情况，抑或是压根不需要代理的 Windows 软件等，这个时候利用 fakeip-filter 来做到：\ndns: # 配置不使用 fake-ip 的域名，代理跳过解析，让系统自己解析 fake-ip-filter: - \"*\" # 只匹配 localhost 等没有. 的主机名 - \"*.lan\" - \"xbox.*.microsoft.com\" - \"+.xboxlive.com\" - \"localhost.ptlogin2.qq.com\" 确定域名后 代理软件通过 fake-ip 确认了客户端想要访问的域名之后，就要开始匹配域名的相关规则，以下是一个域名规则示例：\nrules: - DOMAIN-SUFFIX,baidu.com,REJECT # 直接拒绝 - DOMAIN-SUFFIX,google.com,美国-代理 # 走代理 - DOMAIN-SUFFIX,baidu.com,DIRECT # 直连 示例说的是以下情况：\n当你访问的域名以 baidu.com 结尾时，直接拒绝该请求 当你访问的域名以 google.com 结尾时，走美国代理，此时就由你的美国服务器来负责解析域名对应的 DNS，访问后把响应返回给你 或者是以 baidu.com 结尾，走直连 域名直连 走代理和拒绝没啥多说的，继续讲直连的过程，会进一步查询 DNS 缓存，当发现需要访问的域名在缓存内存在时，就直接获得了其 IP\n当 cache 命中不了的时候，接着会到 nameserver-policy 来解析，nameserver 中文是「域名服务器」，具体负责将域名转成 IP，policy 代表着某种解析的策略，我们可以设置一些规则让某些域名让 A 域名服务器来解析，而另一些让 B 来解析。设置正确的好处是可以更准确更快地获得 IP，比如你访问国内，用阿里和腾讯的域名服务器来解析；访问国外的，就用谷歌和 Cloudflare 的来解析\n再具体介绍 nameserver-policy 之前，先得判断域名是否是国内或国外，这里需要借助 geosite 和 geoip 的帮助，并成为 geodata。这两个资源文件将一些域名和 IP 对应的地区进行配对，当然，有些情况里面还会有自定义的分组，比如所有 Steam 相关的域名和 IP 等\n我们可以配置 geodata 的加载地址，我这里用的是 Mihomo 社区中的配置，有些读者 可能在用 Loyalsoldier 的 v2ray-rules-dat 和 geoip，其实 Mihomo 社区的跟前面两个基本上是一致的，比较大的不同是社区的删掉了 geosite 中大部分的广告域名，因为仅靠 geosite 来屏蔽广告是很有限的。我本人是用了其他的来规避广告（下文会具体展开），所以就选择社区的版本。这里还用 cdn 了进行加速，原生的 GitHub release 有时候可能访问不上\n# 用 dat 格式文件来加载 geoip，默认为 false，用 mmdb 格式文件 geodata-mode: true geo-auto-update: true # 自动更新 geodata geo-update-interval: 24 # 24 小时更新一次 # 自定义 geodata 的加载地址 geox-url: # geoip，geosite 存储的是 IP 和域名对应的分组，可能是国家，也可能是某些分组，比如广告 geoip: \"https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat\" geosite: \"https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat\" # 这里用 dat 就没必要配置 mmdb # ASN 指的是一些注册的企业，机构和个人，参见 https://github.com/VirgilClyne/GetSomeFries/wiki/%F0%9F%8C%90-ASN#%E7%AE%80%E4%BB%8B asn: \"https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/GeoLite2-ASN.mmdb\" 接着我们来设置 nameserver-policy，国内的全送给阿里和腾讯的域名服务器进行解析，而国外的由谷歌和 Cloudflare 来负责解析\ndns: nameserver-policy: # private 其实指的是 Reserved IP（保留地址），比如 192.168.0.0 \"geosite:cn,private\": - https://223.5.5.5/dns-query # 阿里 - https://120.53.53.53/dns-query # 腾讯 \"geosite:geolocation-!cn\": # 已经包含了 gfw 类 - \"https://dns.cloudflare.com/dns-query\" - \"https://dns.google/dns-query\" 如果设置了 nameserver-policy 并且匹配成功，就会通过指定的 nameserver 来进行解析，如果解析成功，就直接获得 IP；而如果解析失败，也就失败了，并没有兜底规则！\n解析失败并没有兜底规则这一点提醒我们用起来需要注意风险，网上有一些配置预先设置了很多的策略，比如阿里的服务，腾讯的服务，B 站的服务等等全部进行分开解析，放到策略里。我个人并不推荐，因为有时候解析会错误，我之前是模仿网上的配置将 B 站的解析送到腾讯的域名服务器，然后就遇到过解析不出来的情况。反正多一次并发 DNS 查询并不会很大程度影响性能，何必要大费周章地预置呢，还会增加风险 :doge\n当没有设置 nameserver-policy 时，就走全局的 nameserver 来解析。读到这里读者可能会疑惑，上述的 nameserver-policy 不是已经涵盖了所有的网站嘛，国内和国外，这里的 nameserver 设置是否不必要了呢？答案是肯定有必要，因为 geosite 是一个规则集，有些网站并未包含在这些规则内，比如常见的个人小型博客，所以还需要默认的 nameserver 的规则\ndns: nameserver: - https://223.5.5.5/dns-query # 阿里 - https://120.53.53.53/dns-query # 腾讯 fallback: - \"https://dns.cloudflare.com/dns-query\" - \"https://dns.google/dns-query\" # 如果满足了 filter 的条件，就用 nameserver 的解析结果 # 否则就用 fallback 的解析结果 fallback-filter: geoip-code: CN 这里一旦设置了 fallback 项，nameserver 并发解析的同时，还会向 fallback 里的域名服务器并发请求，然后根据设置的 fallback-filter 来决定最终用谁的解析结果。这里是说如果是国内就用阿里和腾讯的解析结果，而国外就用谷歌和 Cloudflare 的解析结果，避免 DNS 被污染\n多余的 DNS 解析 有些时候当你的配置文件写的不对时，代理软件会进行多余的 DNS 解析，比如说当你访问 google.com，明明你的规则集里写了遇到谷歌走代理，但你打开代理软件 log 时发现谷歌域名对应的 IP 还是被解析好了，这就是上图中画的另外一种情况：你的 IP 规则写到了域名规则中，比如这种情况：\nrules: - IP-CIDR,103.151.150.0/23,香港-代理 - DOMAIN-SUFFIX,google.com,美国-代理 Mihomo 内核是从上往下的顺序进行检查的，也就是说当代理软件发现有 IP 相关的规则，它会首先将 google.com 转换成 IP，然后判断是否满足，将 IP 规则混在域名规则中造成了多余的 DNS 解析，因为对于 google.com 的访问我们本来就是直接送给代理节点来进行访问，所以在写配置时要注意域名和 IP 规则进行分开，通常域名规则在上面，而 IP 规则在下\n写好配置 Mihomo_config 这里存放了我个人的 Mihomo 覆写文件，可以进行参考，请务必读懂本文后使用，不要盲目照抄 YAML 在本章我们将写一个 Mihomo 内核的覆写（override）文件，无论以后用何种机场，都可以用覆写文件自动转换，而不必依靠于机场自带的各种落后的分流规则，形同虚设的节点分组等\n注意：这里是 Mihomo 内核的覆写文件，若是 sing-box 等，请进行修改转换\n语法 Mihomo 内核的覆写文件有两种方式，一种是 yaml，另一种是 JavaScript，这里介绍更为简单的 yaml 形式，yaml 语法主要就如下几种：\n# 字典：a = {'b': 1} a: b: 1 # 数组：a = [b, c] a: - b - c 稍微复杂一点的是「锚点」的应用，这里直接摘自 Mihomo 官方对 yaml 语法的介绍\n\u0026 锚点和 * 别名，可以用来引用，\u0026 用来建立锚点，« 表示合并到当前数据，* 用来引用锚点\n如下示例中，因 p 这个键在 mihomo 内置中不存在，所以在 mihomo 解析配置会被忽视\n如合并时有重复的项，则不会去合并\n锚点的使用示例 p: \u0026p type: http interval: 3600 health-check: enable: true url: https://www.gstatic.com/generate_204 interval: 300 proxy-providers: provider1: \u003c\u003c: *p url: \"\" path: ./proxy_providers/provider1.yaml provider2: \u003c\u003c: *p type: file path: ./proxy_providers/provider2.yaml 等同于\n不用锚点的内容 proxy-providers: provider1: type: http interval: 3600 health-check: enable: true url: https://www.gstatic.com/generate_204 interval: 300 url: \"\" path: ./proxy_providers/provider1.yaml provider2: interval: 3600 health-check: enable: true url: https://www.gstatic.com/generate_204 interval: 300 type: file path: ./proxy_providers/provider2.yaml 节点组和策略组 接着我们对节点来进行分组，下面用了正则的写法，HK 节点的意思是说，当发现以香港，或 HK，或 Hong 以及 🇭🇰 开头，并且[网站, 地址, 剩余, ..., 节点]等词没有出现过，一旦出现，就放弃匹配，关于正则表达式，不确定的读者可以去该网站进行查看\nFilterHK: \u0026FilterHK \"^(?=.*(香港|HK|Hong|🇭🇰))^(?!.*(网站|地址|剩余|过期|时间|有效|网址|禁止|邮箱|发布|客服|订阅|节点)).*$\" FilterJP: \u0026FilterJP \"^(?=.*(日本|JP|Japan|🇯🇵))^(?!.*(网站|地址|剩余|过期|时间|有效|网址|禁止|邮箱|发布|客服|订阅|节点)).*$\" 对节点按照地区分好组之后，这里建立选择节点的方式：自动测速和手动选择\n自动选择和手动选择 # 策略组参数锚点 # 手动选择参数 Select: \u0026Select { type: select, url: \"https://cp.cloudflare.com\", disable-udp: false, hidden: false, include-all: true, } # 自动测速参数 Auto: \u0026Auto { type: url-test, url: \"https://cp.cloudflare.com\", interval: 300, tolerance: 50, disable-udp: false, hidden: true, include-all: true, } 然后就有我们的节点策略组了，filter 的意思是针对所有的代理节点留下满足条件的\nproxy-groups: # 自动选择，会自动测速，选择最快的 - { name: 🇭🇰 - 自动选择, \u003c\u003c: *Auto, filter: *FilterHK } # 手动选择 - { name: 🇭🇰 - 手动选择, \u003c\u003c: *Select, filter: *FilterHK } 其他地区相关的节点组和策略组按照如上方式编写即可，编写好之后我们就开始进行按照不同的访问目的来选择不同地区的节点，下面是编了三组，一组是节点选择，包含了自动，手动和 DIRECT；第二组是自动选择，包含所有的自动选择，以及 telegram 的节点策略组，而且默认是用香港的节点（第一个出现的即为默认）\nproxy-groups 示例 proxy-groups: - name: 节点选择 type: select proxies: [自动选择, 手动选择, DIRECT] url: https://cp.cloudflare.com icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/Static.png - name: 自动选择 type: select proxies: [🇭🇰 - 自动选择, 🇯🇵 - 自动选择, 🇰🇷 - 自动选择, 🇸🇬 - 自动选择, 🇺🇸 - 自动选择, 🇬🇧 - 自动选择, 🇫🇷 - 自动选择, 🇩🇪 - 自动选择, 🇹🇼 - 自动选择, 🇲🇾 - 自动选择, 🇹🇭 - 自动选择, 🇻🇳 - 自动选择, 🇹🇷 - 自动选择, 🇦🇷 - 自动选择] url: https://cp.cloudflare.com icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/Urltest.png - name: Telegram type: select proxies: [🇭🇰 - 自动选择, 🇯🇵 - 自动选择, 🇰🇷 - 自动选择, 🇸🇬 - 自动选择, 🇺🇸 - 自动选择, 🇬🇧 - 自动选择, 🇫🇷 - 自动选择, 🇩🇪 - 自动选择, 🇹🇼 - 自动选择, 🇲🇾 - 自动选择, 🇹🇭 - 自动选择, 🇻🇳 - 自动选择, 🇹🇷 - 自动选择, 🇦🇷 - 自动选择] icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/Telegram.png 分流规则 讲完了基础语法，终于来到了最激动的分流规则部分了，本节的大部分规则来自于 Sukka Surge，感谢 Sukka 的贡献~\n首先我们得加载识别访问域名或者 IP 是否是广告的一些规则集，然后我们才能去选择策略，比如 REJECT\n规则集很多配置有重复的地方，这里就先建立锚点，然后来引用锚点使得配置文件更整洁\n规则参数 # 规则参数 [每12小时更新一次订阅规则，更新规则时使用（节点选择）策略] RuleSet_classical: \u0026RuleSet_classical { type: http, behavior: classical, interval: 43200, format: text, proxy: 节点选择, } RuleSet_domain: \u0026RuleSet_domain { type: http, behavior: domain, interval: 43200, format: text, proxy: 节点选择, } RuleSet_ipcidr: \u0026RuleSet_ipcidr { type: http, behavior: ipcidr, interval: 43200, format: text, proxy: 节点选择, } 然后就可以编写规则集，这里不一一列出琐碎的细节，用广告的例子来具体讲一下怎么写，读者应能举一反三\n广告规则集 rule-providers: reject_non_ip_no_drop: \u003c\u003c: *RuleSet_classical url: https://ruleset.skk.moe/Clash/non_ip/reject-no-drop.txt path: ./rule_set/sukkaw_ruleset/reject_non_ip_no_drop.txt reject_non_ip_drop: \u003c\u003c: *RuleSet_classical url: https://ruleset.skk.moe/Clash/non_ip/reject-drop.txt path: ./rule_set/sukkaw_ruleset/reject_non_ip_drop.txt reject_non_ip: \u003c\u003c: *RuleSet_classical url: https://ruleset.skk.moe/Clash/non_ip/reject.txt path: ./rule_set/sukkaw_ruleset/reject_non_ip.txt reject_domainset: \u003c\u003c: *RuleSet_domain url: https://ruleset.skk.moe/Clash/domainset/reject.txt path: ./rule_set/sukkaw_ruleset/reject_domainset.txt reject_extra_domainset: \u003c\u003c: *RuleSet_domain url: https://ruleset.skk.moe/Clash/domainset/reject_extra.txt path: ./sukkaw_ruleset/reject_domainset_extra.txt reject_ip: \u003c\u003c: *RuleSet_classical url: https://ruleset.skk.moe/Clash/ip/reject.txt path: ./rule_set/sukkaw_ruleset/reject_ip.txt 上面的几个规则集一共有两个方面，域名和 IP 来拦截广告，我们配置分流规则务必按照域名和 IP 规则分开，而且是 IP 规则在下，从而避免不必要的 DNS 解析。下面的规则中有一个是 REJECT-DROP，跟直接 REJECT 不同的是该策略收到请求后，直接静默直到超时为止，适合那些被拒绝就立马再发起请求的情况\n分流规则示例 # 分流规则 rules: # 非 IP 类规则必须与 IP 类规则分开，避免不必要的 DNS 解析 # 先是拒绝类，优先级最高，引自 Sukka，包含 uBlock Origin、AdGuard、EasyList 等 - RULE-SET,reject_non_ip,REJECT - RULE-SET,reject_domainset,REJECT - RULE-SET,reject_extra_domainset,REJECT # 可能开启后对性能有影响 - RULE-SET,reject_non_ip_drop,REJECT-DROP - RULE-SET,reject_non_ip_no_drop,REJECT ... # 这里是另外其他的域名规则 # IP 类规则 - RULE-SET,reject_ip,REJECT # 兜底规则 - MATCH,节点选择 这样就写好了一个分流规则，同时分流规则的最后应该是兜底规则，MATCH 的意思是无论什么都会去匹配\n再补充一下常见的几种域名规则，方便读者自定义：\nrules: - DOMAIN,ad.com,REJECT # 完整的域名 - DOMAIN-SUFFIX,google.com,auto # 域名以 google.com 结尾 - DOMAIN-KEYWORD,google,auto # 域名包含关键词 google - DOMAIN-REGEX,^abc.*com,PROXY # 利用正则来匹配，以 abc 开头，包含 com 接着讲讲另一种规则集的常用写法，就是从上文说到的 geodata 来进行配置，也就是从 geosite 和 geoip 来匹配某种特殊用途，前者是域名，后者是 IP。这里屏蔽了 Windows 的一些脏东西，geosite 合并了 crazy-max 的规则\nrules: # 引自 crazy-max 的规则，WIN-SPY 和 WIN-EXTRA 是 Windows 的附加的隐私跟踪域名 # WIN-UPDATE 是 Windows 的自动更新域名 - GEOSITE,WIN-SPY,REJECT - GEOSITE,WIN-EXTRA,REJECT - GEOSITE,WIN-UPDATE,REJECT 但同时也要注意，当你相关规则多了之后，可能会有误杀的情况，比如如上的三条规则就导致你登不上 outlook，所以可以通过代理软件的 log 查看有哪些是必须的，然后救回来即可，不要盲目抄规则\nrule: # 引自 crazy-max 的规则，WIN-SPY 和 WIN-EXTRA 是 Windows 的附加的隐私跟踪域名 # WIN-UPDATE 是 Windows 的自动更新域名 # 有些域名可能被误杀，可以通过 log 来进行补救 - DOMAIN-REGEX,outlook.office.*.com,DIRECT - DOMAIN-SUFFIX,login.microsoftonline.com,DIRECT - GEOSITE,WIN-SPY,REJECT - GEOSITE,WIN-EXTRA,REJECT - GEOSITE,WIN-UPDATE,REJECT 那么如果你想从 geosite 中找到自己想要的类，比如 telegram 呢？可以本地下载 geosite.dat，然后直接记事本打开，然后去搜你想要找的类别，必须要大写搜索，小写会搜到很多域名部分，geosite 中类是大写的，比如 TELEGRAM。另外，有些类是比较杂，会以 “CATEGORY-” 开头，可以搜搜看是否有想要的\n至此你应该能够自己写配置了，接着讲一下我的配置中关于 Sukka 规则的取舍\n广告部分，我全部拿过来，并且启用 CDN 部分，我是专门定制了新的 CDN 节点策略组，专门用自建的节点或者低倍率节点，因为 CDN 通常流量较大 对于苹果和微软可以直连的，直接 DIRECT；不能的则分别建立苹果和微软策略组 对于流媒体部分，我并没有做过多区分，因为我也不咋用，所以就直接放到节点选择了 关于 AIGC的，我专门建立了策略组，默认是美国的节点，港澳台用不了 global 的就直接走节点选择，domestic 就走 DIRECT 另外一点就是移动端如何运用覆写配置呢？我是将电脑端正在运行的配置保存为文件，然后手机导入文件即可\n巧用配置 终于来到了配置的应用环节， 这里分享一些日常可以用到的配置，方便读者使用\n内网开梯子打不开 很多读者发现开着梯子访问公司内网或者校园网打不开，当你读完了上文就会明白，因为当你开了系统代理之后，代理软件接管了 DNS 解析的过程，也就是说代理软件会向常用的域名服务器去查找你的公司或者校园网的域名，这当然是找不到的，内网的域名在公网肯定是解析不到的。那么就可以用到我们之前说的 nameserver-policy 来做到，当我们匹配到特定域名，就让内网的域名服务器来解析，而不是用公网的\n那么如何找到内网的 nameserver 呢？找到 WiFi，然后点开属性，找到以下的即可：\n然后配置好就可以开着系统代理正常访问内网了，下面说的是任何以 xxx.edu.cn 结尾的都可以走我们预设的 DNS 服务器\ndns: nameserver-policy: \"+.xxx.edu.cn\": 10.20.220.50 解锁流媒体 不少机场不同的节点对不同流媒体的解锁情况不一样，那么就可以将可以解锁的代理节点放在一个策略组内，然后将所有的流媒体的分流规则都导到这个策略组即可~\n想要直连 tracker 有些读者可能像我一样日常生活中会用到一些 public 或是 private 的 tracker，有些服务器可能是国外，但是 tracker 一般都能直连，我们不想要代理去连接 tracker，就可以利用分流规则\n幸好先前引入的 geosite 中有一部分是融合了TrackersList以及blackmatrix7 / ios_rule_script，包含了public 和 private 的 tracker\nrules: - GEOSITE,CATEGORY-PUBLIC-TRACKER,DIRECT # 公共 tracker - GEOSITE,CATEGORY-PT,DIRECT # 私有 tracker 使用学校学术资源 有些时候开着代理软件会不可避免的用代理节点来访问学术网站，导致没办法用到学校购买的资源，下载不了论文等，此时我们就可以针对学术网站来制定一个策略组，节点配置就只有一个直连，这样就可以使得即使代理开着，也能用到学校资源\n下列域名规则取自于 hexiao，另外注意，该域名规则应该加在 global 之前，因为优先级是从上而下的，如果一开始匹配到 global，就直接结束了\nrules: # Academic - DOMAIN,tuchong.com,DIRECT - DOMAIN-SUFFIX,taylorandfrancis.com,DIRECT - DOMAIN,dl.acm.org,DIRECT - DOMAIN,acm-prod.disqus.com,DIRECT - DOMAIN-SUFFIX,sciencedirectassets.com,DIRECT - DOMAIN-SUFFIX,readspeaker.com,DIRECT - DOMAIN-SUFFIX,webofknowledge.com,DIRECT - DOMAIN-KEYWORD,pubmed,DIRECT - DOMAIN-KEYWORD,springer,DIRECT - DOMAIN-KEYWORD,ieee,DIRECT - DOMAIN-KEYWORD,elsevier,DIRECT - DOMAIN-KEYWORD,sciencedirect,DIRECT - DOMAIN-KEYWORD,nature,DIRECT - DOMAIN-KEYWORD,tandfonline,DIRECT - DOMAIN-SUFFIX,elsevier.com,DIRECT - DOMAIN-SUFFIX,edu.cn,DIRECT - DOMAIN-SUFFIX,webofscience.com,DIRECT - DOMAIN-SUFFIX,tandfonline.com,DIRECT - DOMAIN-SUFFIX,link.springer.com,DIRECT - DOMAIN-SUFFIX,onlinelibrary.wiley.com,DIRECT - DOMAIN-SUFFIX,sciencedirect.com,DIRECT - DOMAIN-SUFFIX,taylorfrancis.com,DIRECT 开代理访问 IPv6 无论是电脑还是手机端，如果开了代理的情况下还想要访问纯 IPv6 的站点，需要开启 IPv6 相关的设置，一般来说会有总的 IPv6 开关以及 DNS 中的 IPv6 开关。这里有个误区就是你以为你的覆写文件中已经写过开启 IPv6 就可以了，实际上软件层面还要同时去打开设置\n电脑端的 Clash-verge-rev：设置 -\u003e Clash 设置 -\u003e IPv6 手机端的 FlClash：工具 -\u003e 覆写 -\u003e DNS -\u003e 开启覆写 DNS 以及 IPv6；以及工具 -\u003e 覆写 -\u003e 基础 -\u003e IPv6 开关 需要注意的是，当你用 FlClash 开启了 DNS 覆写，那么软件中的设置项就接管了覆写配置中提前设置好的信息，就需要你手动将覆写配置中的信息输入到软件里\n致谢 尽管上文均已提及本文所参考的来源，但有必要再一次列出以示感谢，排名不分先后~\nSukka 关于规则集的相关配置 yyhhyy 在 Mihomo party 的配置教程 Mihomo 官方文档 Mihomo 官方的规则 geodata 集合 Loyalsoldier 的 geodata 集合: geosite和 geoip VirgilClyne 关于 ASN 的介绍 crazy-max 提供屏蔽 Windows 隐私以及更新的域名 学术规则来源自 hexiao 的博客 策略组的图标来自于 Orz-3 geodata 中的 tracker 来自于 XIU2 以及 blackmatrix7 Sing-Box 软件 Clash Verge Rev FlClash ","wordCount":"8615","inLanguage":"en","datePublished":"2024-12-29T14:38:00+08:00","dateModified":"2025-01-07T17:10:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://yunpengtai.top/posts/know-mihomo/"},"publisher":{"@type":"Organization","name":"Tai's Blog","logo":{"@type":"ImageObject","url":"http://yunpengtai.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://yunpengtai.top accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://yunpengtai.top/archives/ title=归档><span>归档</span></a></li><li><a href=http://yunpengtai.top/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=http://yunpengtai.top/categories/%E6%8A%98%E8%85%BE title=折腾><span>折腾</span></a></li><li><a href=http://yunpengtai.top/tags/ title=标签><span>标签</span></a></li><li><a href=http://yunpengtai.top/friends/ title=友人><span>友人</span></a></li><li><a href=http://yunpengtai.top/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://yunpengtai.top>Home</a>&nbsp;»&nbsp;<a href=http://yunpengtai.top/posts/>Posts</a></div><h1 class=post-title>「网络代理」这件小事</h1><div class=post-meta><span title='2024-12-29 14:38:00 +0800 CST'>December 29, 2024</span>&nbsp;·&nbsp;Updated:&nbsp;January 7, 2025&nbsp;·&nbsp;8615 words<div class=meta-item>&nbsp·&nbsp
                <a href=http://yunpengtai.top/categories/%E6%8A%98%E8%85%BE/>折腾</a></div></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%bc%95%e5%ad%90 aria-label=引子>引子</a></li><li><a href=#%e5%ae%a2%e6%88%b7%e7%ab%af aria-label=客户端>客户端</a><ul><li><a href=#%e7%94%b5%e8%84%91%e7%ab%af aria-label=电脑端>电脑端</a></li><li><a href=#%e7%a7%bb%e5%8a%a8%e7%ab%af aria-label=移动端>移动端</a></li></ul></li><li><a href=#%e5%bd%93%e4%bd%a0%e8%ae%bf%e9%97%ae%e6%97%b6 aria-label=当你访问时>当你访问时</a><ul><li><a href=#%e7%a1%ae%e5%ae%9a%e5%9f%9f%e5%90%8d%e5%89%8d aria-label=确定域名前>确定域名前</a></li><li><a href=#%e7%a1%ae%e5%ae%9a%e5%9f%9f%e5%90%8d%e5%90%8e aria-label=确定域名后>确定域名后</a><ul><li><a href=#%e5%9f%9f%e5%90%8d%e7%9b%b4%e8%bf%9e aria-label=域名直连>域名直连</a></li><li><a href=#%e5%a4%9a%e4%bd%99%e7%9a%84-dns-%e8%a7%a3%e6%9e%90 aria-label="多余的 DNS 解析">多余的 DNS 解析</a></li></ul></li></ul></li><li><a href=#%e5%86%99%e5%a5%bd%e9%85%8d%e7%bd%ae aria-label=写好配置>写好配置</a><ul><li><a href=#%e8%af%ad%e6%b3%95 aria-label=语法>语法</a></li><li><a href=#%e8%8a%82%e7%82%b9%e7%bb%84%e5%92%8c%e7%ad%96%e7%95%a5%e7%bb%84 aria-label=节点组和策略组>节点组和策略组</a></li><li><a href=#%e5%88%86%e6%b5%81%e8%a7%84%e5%88%99 aria-label=分流规则>分流规则</a></li></ul></li><li><a href=#%e5%b7%a7%e7%94%a8%e9%85%8d%e7%bd%ae aria-label=巧用配置>巧用配置</a><ul><li><a href=#%e5%86%85%e7%bd%91%e5%bc%80%e6%a2%af%e5%ad%90%e6%89%93%e4%b8%8d%e5%bc%80 aria-label=内网开梯子打不开>内网开梯子打不开</a></li><li><a href=#%e8%a7%a3%e9%94%81%e6%b5%81%e5%aa%92%e4%bd%93 aria-label=解锁流媒体>解锁流媒体</a></li><li><a href=#%e6%83%b3%e8%a6%81%e7%9b%b4%e8%bf%9e-tracker aria-label="想要直连 tracker">想要直连 tracker</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e5%ad%a6%e6%a0%a1%e5%ad%a6%e6%9c%af%e8%b5%84%e6%ba%90 aria-label=使用学校学术资源>使用学校学术资源</a></li><li><a href=#%e5%bc%80%e4%bb%a3%e7%90%86%e8%ae%bf%e9%97%ae-ipv6 aria-label="开代理访问 IPv6">开代理访问 IPv6</a></li></ul></li><li><a href=#%e8%87%b4%e8%b0%a2 aria-label=致谢>致谢</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=引子>引子<a hidden class=anchor aria-hidden=true href=#引子>#</a></h2><p>代理，对于很多人来说并不陌生，尤其是在科研领域，例如在谷歌学术上查找论文的 BibTeX 时。然而，我们常常对网络代理的原理、功能以及如何更好地配置等问题缺乏深入了解。这其实是不可取的，因为网络代理已经深入到我们生活的方方面面，因此，我们更应该去理解它，并让它更好地为我们服务。</p><p>然而，网上关于代理具体原理的解释却相对匮乏，大多是零星片段，甚至存在互相矛盾之处。官方文档也往往仅限于对某些具体配置的说明。为此，笔者投入了大量精力，广泛阅读了各类文献和相关博客，力求去芜存菁，汇聚成本文。对于部分文献未涉及之处，笔者结合自身理解进行了补充，但囿于水平，恐有疏漏。若读者能及时指出，笔者将不胜感激！</p><div class="notice notice-warning"><div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 576 512"><path d="M570 440c18 32-5 72-42 72H48c-37 0-60-40-42-72L246 24c19-32 65-32 84 0l240 416zm-282-86a46 46 0 100 92 46 46 0 000-92zm-44-165 8 136c0 6 5 11 12 11h48c7 0 12-5 12-11l8-136c0-7-5-13-12-13h-64c-7 0-12 6-12 13z"/></svg></div><p>请注意，本文只讨论计算机网络中的各种原理，若读者将此用于违法之事，读者应个人承担相应责任，与本文和作者无关！</p></div><h2 id=客户端>客户端<a hidden class=anchor aria-hidden=true href=#客户端>#</a></h2><p>在展开对具体技术细节的讨论之前，我们先来聊聊「客户端」的选择，因为客户端的些许不同，会导致支持的功能也会存在差异。这里我主要介绍我正在用的几款开源软件，读者可以根据需要进行取舍</p><p>本章只会介绍电脑端以及移动端，至于其他的如路由器等，请读者自行查阅资料</p><h3 id=电脑端>电脑端<a hidden class=anchor aria-hidden=true href=#电脑端>#</a></h3><p>我个人是在使用 Windows 11 23H2，不过读者不必担心自己是 MacOS 抑或是 Linux，我用的软件是多端适配~</p><p>我早期用的软件是 Clash for Windows（CFW），后面 CFW 因为一些不可抗力原因呢就停止了维护，我就去寻找了其他的软件，用过 <a href=https://github.com/zzzgydi/clash-verge>Clash Verge</a> 一段时间，后面这个也停止维护了，然后目前是有人接力了 Verge 继续开发，叫 <a href=https://github.com/clash-verge-rev/clash-verge-rev>Clash Verge Rev</a>，目前我也一直在用，软件也在积极更新中~</p><p><img loading=lazy src=https://png.yunpengtai.top/2025/01/68c1153de6e0a9191065d70b0c90f7b6.png alt=image.png></p><p>UI 还不错，而且最关键的是内置了 <a href=https://github.com/MetaCubeX/mihomo>Clash Meta（Mihomo）</a>内核，对于小白来说，可以这样理解：内核实现了诸多复杂的功能，比如自定义一些域名的代理，比如浏览 google.com 用香港的节点，目前 Mihomo 也是社区中维护最为频繁而且功能也好用的内核
<span class=sidenote-number><small class=sidenote>附上社区中支持 Mihomo 的<a href=https://wiki.metacubex.one/startup/client/client/>软件清单</a>供读者参考，本文只会介绍我用过的软件</small></span></p><p>有些读者可能在用，或者考虑用 <a href=https://github.com/mihomo-party-org/mihomo-party>Mihomo Party</a>，我个人使用过一段时间，并不推荐，尤其是对于自己写覆写配置的人来说，因为它这个软件很多地方压根不遵循你的配置，比如关于 geodata 的地址，更新频率，甚至你明明在配置里写明 DNS 支持 IPv6，然而你点开正在运行的配置，IPv6 还是 false，有很多地方你都得手动去 check，不建议使用，而上面的 clash verge rev 基本都遵循你的覆写配置，我目前检查下来只有总的 IPv6 控制需要额外去软件设置</p><h3 id=移动端>移动端<a hidden class=anchor aria-hidden=true href=#移动端>#</a></h3><p>我个人用的是 Android 手机，安卓端一开始我用的是 <a href=https://github.com/MetaCubeX/ClashMetaForAndroid>Clash Meta for Android</a>，也是支持 Mihomo 内核的。然而发现这款软件用途有些局限，手机流量连接时开代理没法访问我的纯 IPv6 服务器，即使配置和软件覆写中 IPv6 全开的情况（解决方案可以看本文的<a href=/posts/know-mihomo/#%E5%BC%80%E4%BB%A3%E7%90%86%E8%AE%BF%E9%97%AE-ipv6>开代理访问IPv6</a>），寻找解决方案时发现另一款软件叫 <a href=https://github.com/chen08209/FlClash>FlClash</a>， 不仅能够解决我这个问题，UI 支持 material you 以及配置中的图标，就很好看；同时可定义的配置更多</p><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script>
<a data-fancybox=gallery href=https://png.yunpengtai.top/2025/01/19fc4c78fb34abede66beb7d40111223.jpg><figure class=align-center><img loading=lazy src=https://png.yunpengtai.top/2025/01/19fc4c78fb34abede66beb7d40111223.jpg#center width=300px height=600px></figure></a><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script>
<a data-fancybox=gallery href=https://png.yunpengtai.top/2025/01/0c2bdf66e3c8de32327ce55dcec768ec.jpg><figure class=align-center><img loading=lazy src=https://png.yunpengtai.top/2025/01/0c2bdf66e3c8de32327ce55dcec768ec.jpg#center width=300px height=600px></figure></a><p>说完了 Android，我还有一台 iPad，目前是在用 <a href=https://github.com/SagerNet/sing-box>sing-box</a>和 Shadowsocket，后者自不必多说，比较简单的代理软件，前者也在用的原因是其免费，同时也支持比较复杂的功能，比如 AdGuard DNS Filter，当然读者如果已经购买了 Surge 等软件，可以继续沿用~</p><h2 id=当你访问时>当你访问时<a hidden class=anchor aria-hidden=true href=#当你访问时>#</a></h2><p>接下来讨论一些更有趣的，本章会详细介绍客户端向你的代理软件发起请求时，Mihomo 内核的 DNS 工作流程，比如浏览器访问某个网页</p><p>如果一开始客户端访问的就是 IP，就不用费很多事，直接到关于 IP 的规则，比如是直连还是走代理等，不需要域名解析。下面是一个简单的 IP 规则举例，CIDR 表示 IP 的范围</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 以 192.168.1.0 开始的 IP 段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>IP-CIDR,192.168.1.0/23,DIRECT</span><span class=w> </span><span class=c># 走直连</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>IP-CIDR,103.151.150.0/23,香港-代理</span><span class=w> </span><span class=c># 走香港-代理</span><span class=w>
</span></span></span></code></pre></div><p>走代理的意思是说，代理软件将访问的请求发送给你的代理节点（这里就是香港的服务器），然后代理节点将访问接收到的 IP 或者域名，最后代理节点会把响应返回给代理软件；走直连的意思是直接和该 IP 进行连接</p><p>而对于域名的访问就要复杂一些，故而接下来将详细讨论客户端向某个域名发起请求会具体发生什么，为了让概念更加清晰易懂，下面的流程图中省略了 IP 规则的部分
<span class=sidenote-number><small class=sidenote>部分参考自 Mihomo 官方<a href=https://wiki.metacubex.one/config/dns/diagram/>文档</a></small></span></p><pre class=mermaid>flowchart TB
  Start[客户端发起请求] --&gt; fake[fake-ip 反查]
  fake[fake-ip 反查] --&gt; Domain[基于域名匹配规则]
  fake --&gt; |fakeip-filter|system[系统解析 DNS]

  Domain --&gt; |匹配过程中|IP[遇到 IP 规则]
  Domain --&gt; reject[匹配到 Reject 规则]
  Domain --&gt; |匹配到直连规则|Cache
  IP --&gt; Cache

  Domain --&gt; |匹配到代理规则|Remote[通过代理服务器解析域名并建立连接]

  Cache --&gt; |Cache 未命中|NS[匹配 nameserver-policy 并查询 ]
  Cache --&gt; |Cache 命中|Get

  NS --&gt; |匹配成功| Get[将查询到的 IP 用于匹配 IP 规则]
  NS --&gt; |没匹配到| NF[nameserver/fallback 并发查询]

  NF --&gt; Get[查询得到 IP]
  Get --&gt; |缓存 DNS 结果|Cache[(查询 DNS 缓存)]
</pre><h3 id=确定域名前>确定域名前<a hidden class=anchor aria-hidden=true href=#确定域名前>#</a></h3><p>在讲具体的域名规则之前，我们还得确保一件事：就是你的代理软件得知道你访问的「目标域名」，听起来是不是有点意外。有时候代理软件不知道你访问的目标域名是什么，比如以下情况：</p><p>假设你的浏览器没有直接通过代理协议（如 socks5 或 http 代理）将请求发送到代理软件，而是依赖系统的普通网络栈。在这种情况下，浏览器会向系统发起域名解析，操作系统会通过本地的 DNS 服务器将域名解析为 IP 地址。然后，浏览器使用这个 IP 地址建立连接。这种场景下，浏览器完全没有直接传递域名给代理，代理只知道「一个 IP 地址」</p><p>那这个时候很有可能就会有问题，因为代理压根不知道你访问的是哪个域名：故而需要引入一个新的机制：fake-ip
<span class=sidenote-number><small class=sidenote>因为 redir-host 已经过时了，故本文并不会进行讨论</small></span></p><p>fake-ip 的定义出自 <a href=https://tools.ietf.org/rfc/rfc3089>RFC3089</a>，关于 fake-ip 的介绍，Clash <a href=https://clash.wiki/configuration/dns.html>知识库</a>介绍的很好，我这里摘抄一下：</p><p>fake-ip 池的默认 CIDR 是 198.18.0.1/16，一个保留的 IPv4 地址空间（CIDR 表示的是一个 IP 范围）</p><p>当 DNS 请求被发送到 Clash DNS 时，Clash 内核会通过管理内部的域名和其 fake-ip 地址的映射，从池中分配一个空闲的 fake-ip 地址</p><p>以使用浏览器访问 <a href=https://google.com>https://google.com</a> 为例</p><ol><li>浏览器向 Clash DNS 请求 google.com 的 IP 地址</li><li>Clash 检查内部映射并返回 198.18.1.5</li><li>浏览器向 198.18.1.5 的 80/tcp 端口发送 HTTP 请求</li><li>当收到 198.18.1.5 的入站数据包时，Clash 查询内部映射，发现客户端实际上是在向 google.com 发送数据包</li><li>a. Clash 可能仅将域名发送到 SOCKS5 或 shadowsocks 等出站代理，并与代理服务器建立连接；b. 或者 Clash 可能会基于 SCRIPT、GEOIP、IP-CIDR 规则或者使用 DIRECT 直连出口查询 google.com 的真实 IP 地址</li></ol><div class="notice notice-tip"><div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 512 512"><path d="M504 256A248 248 0 118 256a248 248 0 01496 0zM227 387l184-184c7-6 7-16 0-22l-22-23c-7-6-17-6-23 0L216 308l-70-70c-6-6-16-6-23 0l-22 23c-7 6-7 16 0 22l104 104c6 7 16 7 22 0z"/></svg></div><p>我总结一下：简而言之，fake-ip 通过拦截客户端的解析请求从而知道真正需要访问的域名是什么，进而可以使用提前设置的分流规则</p></div><p>当然，你可能会疑惑，我明明都输入了 google.com 了，为什么还要「多此一举」呢？尽管大多数时候客户端的请求中都指明了访问的域名，但有些时候并不能直接获得域名，所以得都拦截下来，以确保代理知道你要访问的域名</p><p>刚刚我们也说过会有系统接管 DNS 解析的情况，有些我们并不需要通过代理软件进行解析，比如访问 <code>localhost:8080</code> 这种本地的情况，抑或是压根不需要代理的 Windows 软件等，这个时候利用 fakeip-filter 来做到：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 配置不使用 fake-ip 的域名，代理跳过解析，让系统自己解析</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fake-ip-filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;*&#34;</span><span class=w> </span><span class=c># 只匹配 localhost 等没有. 的主机名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;*.lan&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;xbox.*.microsoft.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;+.xboxlive.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;localhost.ptlogin2.qq.com&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=确定域名后>确定域名后<a hidden class=anchor aria-hidden=true href=#确定域名后>#</a></h3><p>代理软件通过 fake-ip 确认了客户端想要访问的域名之后，就要开始匹配域名的相关规则，以下是一个域名规则示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,baidu.com,REJECT</span><span class=w> </span><span class=c># 直接拒绝</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,google.com,美国-代理</span><span class=w> </span><span class=c># 走代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,baidu.com,DIRECT</span><span class=w> </span><span class=c># 直连</span><span class=w>
</span></span></span></code></pre></div><p>示例说的是以下情况：</p><ol><li>当你访问的域名以 baidu.com 结尾时，直接拒绝该请求</li><li>当你访问的域名以 google.com 结尾时，走美国代理，此时就由你的美国服务器来负责解析域名对应的 DNS，访问后把响应返回给你</li><li>或者是以 baidu.com 结尾，走直连</li></ol><h4 id=域名直连>域名直连<a hidden class=anchor aria-hidden=true href=#域名直连>#</a></h4><p>走代理和拒绝没啥多说的，继续讲直连的过程，会进一步查询 DNS 缓存，当发现需要访问的域名在缓存内存在时，就直接获得了其 IP</p><p>当 cache 命中不了的时候，接着会到 nameserver-policy 来解析，nameserver 中文是「域名服务器」，具体负责将域名转成 IP，policy 代表着某种解析的策略，我们可以设置一些规则让某些域名让 A 域名服务器来解析，而另一些让 B 来解析。设置正确的好处是可以更准确更快地获得 IP，比如你访问国内，用阿里和腾讯的域名服务器来解析；访问国外的，就用谷歌和 Cloudflare 的来解析</p><p>再具体介绍 nameserver-policy 之前，先得判断域名是否是国内或国外，这里需要借助 geosite 和 geoip 的帮助，并成为 geodata。这两个资源文件将一些域名和 IP 对应的地区进行配对，当然，有些情况里面还会有自定义的分组，比如所有 Steam 相关的域名和 IP 等</p><p>我们可以配置 geodata 的加载地址，我这里用的是 Mihomo 社区中的<a href=https://github.com/MetaCubeX/meta-rules-dat>配置</a>，有些读者 可能在用 Loyalsoldier 的 <a href=https://github.com/Loyalsoldier/v2ray-rules-dat>v2ray-rules-dat</a> 和 <a href=https://github.com/Loyalsoldier/geoip>geoip</a>，其实 Mihomo 社区的跟前面两个基本上是一致的，比较大的不同是社区的删掉了 geosite 中大部分的广告域名，因为仅靠 geosite 来屏蔽广告是很有限的。我本人是用了其他的来规避广告（下文会具体展开），所以就选择社区的版本。这里还用 cdn 了进行加速，原生的 GitHub release 有时候可能访问不上</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 用 dat 格式文件来加载 geoip，默认为 false，用 mmdb 格式文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>geodata-mode</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>geo-auto-update</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=c># 自动更新 geodata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>geo-update-interval</span><span class=p>:</span><span class=w> </span><span class=m>24</span><span class=w> </span><span class=c># 24 小时更新一次</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 自定义 geodata 的加载地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>geox-url</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># geoip，geosite 存储的是 IP 和域名对应的分组，可能是国家，也可能是某些分组，比如广告</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>geoip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>geosite</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 这里用 dat 就没必要配置 mmdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># ASN 指的是一些注册的企业，机构和个人，参见 https://github.com/VirgilClyne/GetSomeFries/wiki/%F0%9F%8C%90-ASN#%E7%AE%80%E4%BB%8B</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>asn</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/GeoLite2-ASN.mmdb&#34;</span><span class=w>
</span></span></span></code></pre></div><p>接着我们来设置 nameserver-policy，国内的全送给阿里和腾讯的域名服务器进行解析，而国外的由谷歌和 Cloudflare 来负责解析</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># private 其实指的是 Reserved IP（保留地址），比如 192.168.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;geosite:cn,private&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://223.5.5.5/dns-query</span><span class=w> </span><span class=c># 阿里</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://120.53.53.53/dns-query</span><span class=w> </span><span class=c># 腾讯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;geosite:geolocation-!cn&#34;: </span><span class=c># 已经包含了 gfw 类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;https://dns.cloudflare.com/dns-query&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;https://dns.google/dns-query&#34;</span><span class=w>
</span></span></span></code></pre></div><div class="notice notice-warning"><div class=notice-title><svg xmlns="http://www.w3.org/2000/svg" class="icon notice-icon" viewBox="0 0 576 512"><path d="M570 440c18 32-5 72-42 72H48c-37 0-60-40-42-72L246 24c19-32 65-32 84 0l240 416zm-282-86a46 46 0 100 92 46 46 0 000-92zm-44-165 8 136c0 6 5 11 12 11h48c7 0 12-5 12-11l8-136c0-7-5-13-12-13h-64c-7 0-12 6-12 13z"/></svg></div><p>如果设置了 nameserver-policy 并且匹配成功，就会通过指定的 nameserver 来进行解析，如果解析成功，就直接获得 IP；而如果解析失败，也就失败了，并没有兜底规则！</p></div><p>解析失败并没有兜底规则这一点提醒我们用起来需要注意风险，网上有一些配置预先设置了很多的策略，比如阿里的服务，腾讯的服务，B 站的服务等等全部进行分开解析，放到策略里。我个人并不推荐，因为有时候解析会错误，我之前是模仿网上的配置将 B 站的解析送到腾讯的域名服务器，然后就遇到过解析不出来的情况。反正多一次并发 DNS 查询并不会很大程度影响性能，何必要大费周章地预置呢，还会增加风险 :doge</p><p>当没有设置 nameserver-policy 时，就走全局的 nameserver 来解析。读到这里读者可能会疑惑，上述的 nameserver-policy 不是已经涵盖了所有的网站嘛，国内和国外，这里的 nameserver 设置是否不必要了呢？答案是肯定有必要，因为 geosite 是一个规则集，有些网站并未包含在这些规则内，比如常见的个人小型博客，所以还需要默认的 nameserver 的规则</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://223.5.5.5/dns-query</span><span class=w> </span><span class=c># 阿里</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://120.53.53.53/dns-query</span><span class=w> </span><span class=c># 腾讯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fallback</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;https://dns.cloudflare.com/dns-query&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;https://dns.google/dns-query&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 如果满足了 filter 的条件，就用 nameserver 的解析结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 否则就用 fallback 的解析结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fallback-filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>geoip-code</span><span class=p>:</span><span class=w> </span><span class=l>CN</span><span class=w>
</span></span></span></code></pre></div><p>这里一旦设置了 fallback 项，nameserver 并发解析的同时，还会向 fallback 里的域名服务器并发请求，然后根据设置的 fallback-filter 来决定最终用谁的解析结果。这里是说如果是国内就用阿里和腾讯的解析结果，而国外就用谷歌和 Cloudflare 的解析结果，避免 DNS 被污染</p><h4 id=多余的-dns-解析>多余的 DNS 解析<a hidden class=anchor aria-hidden=true href=#多余的-dns-解析>#</a></h4><p>有些时候当你的配置文件写的不对时，代理软件会进行多余的 DNS 解析，比如说当你访问 google.com，明明你的规则集里写了遇到谷歌走代理，但你打开代理软件 log 时发现谷歌域名对应的 IP 还是被解析好了，这就是上图中画的另外一种情况：你的 IP 规则写到了域名规则中，比如这种情况：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>IP-CIDR,103.151.150.0/23,香港-代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,google.com,美国-代理</span><span class=w>
</span></span></span></code></pre></div><p>Mihomo 内核是从上往下的顺序进行检查的，也就是说当代理软件发现有 IP 相关的规则，它会首先将 google.com 转换成 IP，然后判断是否满足，将 IP 规则混在域名规则中造成了多余的 DNS 解析，因为对于 google.com 的访问我们本来就是直接送给代理节点来进行访问，所以在写配置时要注意域名和 IP 规则进行分开，通常域名规则在上面，而 IP 规则在下</p><h2 id=写好配置>写好配置<a hidden class=anchor aria-hidden=true href=#写好配置>#</a></h2><div class=github><div class=github_bar><svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50"><path d="M17.791 46.836C18.502 46.53 19 45.823 19 45v-5.4c0-.197.016-.402.041-.61C19.027 38.994 19.014 38.997 19 39c0 0-3 0-3.6.0-1.5.0-2.8-.6-3.4-1.8-.7-1.3-1-3.5-2.8-4.7C8.9 32.3 9.1 32 9.7 32c.6.1 1.9.9 2.7 2 .9 1.1 1.8 2 3.4 2 2.487.0 3.82-.125 4.622-.555C21.356 34.056 22.649 33 24 33v-.025c-5.668-.182-9.289-2.066-10.975-4.975-3.665.042-6.856.405-8.677.707-.058-.327-.108-.656-.151-.987 1.797-.296 4.843-.647 8.345-.714-.112-.276-.209-.559-.291-.849-3.511-.178-6.541-.039-8.187.097-.02-.332-.047-.663-.051-.999 1.649-.135 4.597-.27 8.018-.111-.079-.5-.13-1.011-.13-1.543.0-1.7.6-3.5 1.7-5-.5-1.7-1.2-5.3.2-6.6 2.7.0 4.6 1.3 5.5 2.1C21 13.4 22.9 13 25 13s4 .4 5.6 1.1c.9-.8 2.8-2.1 5.5-2.1 1.5 1.4.7 5 .2 6.6 1.1 1.5 1.7 3.2 1.6 5 0 .484-.045.951-.11 1.409 3.499-.172 6.527-.034 8.204.102-.002.337-.033.666-.051.999-1.671-.138-4.775-.28-8.359-.089-.089.336-.197.663-.325.98 3.546.046 6.665.389 8.548.689-.043.332-.093.661-.151.987-1.912-.306-5.171-.664-8.879-.682-1.665 2.878-5.22 4.755-10.777 4.974V33c2.6.0 5 3.9 5 6.6V45c0 .823.498 1.53 1.209 1.836C41.37 43.804 48 35.164 48 25 48 12.318 37.683 2 25 2S2 12.318 2 25C2 35.164 8.63 43.804 17.791 46.836z"/></svg><a class=github_name href=https://github.com/sherlcok314159/Mihomo_config target=_blank>Mihomo_config</a></div><div class=github_description>这里存放了我个人的 Mihomo 覆写文件，可以进行参考，请务必读懂本文后使用，不要盲目照抄</div><div class=github_language>YAML</div></div><p>在本章我们将写一个 Mihomo 内核的覆写（override）文件，无论以后用何种机场，都可以用覆写文件自动转换，而不必依靠于机场自带的各种落后的分流规则，形同虚设的节点分组等</p><p>注意：这里是 Mihomo 内核的覆写文件，若是 sing-box 等，请进行修改转换</p><h3 id=语法>语法<a hidden class=anchor aria-hidden=true href=#语法>#</a></h3><p>Mihomo 内核的覆写文件有两种方式，一种是 yaml，另一种是 JavaScript，这里介绍更为简单的 yaml 形式，yaml 语法主要就如下几种：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 字典：a = {&#39;b&#39;: 1}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>a</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>b</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 数组：a = [b, c]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>a</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>c</span><span class=w>
</span></span></span></code></pre></div><p>稍微复杂一点的是「锚点」的应用，这里直接摘自 Mihomo 官方对 yaml 语法的<a href=https://wiki.metacubex.one/handbook/syntax/>介绍</a></p><p>& 锚点和 * 别名，可以用来引用，& 用来建立锚点，&#171; 表示合并到当前数据，* 用来引用锚点</p><p>如下示例中，因 p 这个键在 mihomo 内置中不存在，所以在 mihomo 解析配置会被忽视</p><p>如合并时有重复的项，则不会去合并</p><p><details><summary markdown=span>锚点的使用示例</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>p</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;p</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>3600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health-check</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://www.gstatic.com/generate_204</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>proxy-providers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>provider1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=cp>*p</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./proxy_providers/provider1.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>provider2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=cp>*p</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./proxy_providers/provider2.yaml</span><span class=w>
</span></span></span></code></pre></div></details></p><p>等同于</p><p><details><summary markdown=span>不用锚点的内容</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>proxy-providers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>provider1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>3600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>health-check</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://www.gstatic.com/generate_204</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./proxy_providers/provider1.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>provider2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>3600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>health-check</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://www.gstatic.com/generate_204</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./proxy_providers/provider2.yaml</span><span class=w>
</span></span></span></code></pre></div></details></p><h3 id=节点组和策略组>节点组和策略组<a hidden class=anchor aria-hidden=true href=#节点组和策略组>#</a></h3><p>接着我们对节点来进行分组，下面用了正则的写法，HK 节点的意思是说，当发现以香港，或 HK，或 Hong 以及 🇭🇰 开头，并且<code>[网站, 地址, 剩余, ..., 节点]</code>等词没有出现过，一旦出现，就放弃匹配，关于正则表达式，不确定的读者可以去<a href=https://regex101.com/>该网站</a>进行查看</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>FilterHK</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;FilterHK</span><span class=w> </span><span class=s2>&#34;^(?=.*(香港|HK|Hong|🇭🇰))^(?!.*(网站|地址|剩余|过期|时间|有效|网址|禁止|邮箱|发布|客服|订阅|节点)).*$&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>FilterJP</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;FilterJP</span><span class=w> </span><span class=s2>&#34;^(?=.*(日本|JP|Japan|🇯🇵))^(?!.*(网站|地址|剩余|过期|时间|有效|网址|禁止|邮箱|发布|客服|订阅|节点)).*$&#34;</span><span class=w>
</span></span></span></code></pre></div><p>对节点按照地区分好组之后，这里建立选择节点的方式：自动测速和手动选择</p><p><details><summary markdown=span>自动选择和手动选择</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 策略组参数锚点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 手动选择参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Select</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cp>&amp;Select</span><span class=w> </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>select,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cp.cloudflare.com&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>disable-udp</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hidden</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include-all</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 自动测速参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Auto</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cp>&amp;Auto</span><span class=w> </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>url-test,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://cp.cloudflare.com&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>300</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tolerance</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>disable-udp</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hidden</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include-all</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>}<span class=w>
</span></span></span></code></pre></div></details></p><p>然后就有我们的节点策略组了，filter 的意思是针对所有的代理节点留下满足条件的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>proxy-groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 自动选择，会自动测速，选择最快的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- {<span class=w> </span><span class=nt>name: 🇭🇰 - 自动选择, &lt;&lt;: *Auto, filter</span><span class=p>:</span><span class=w> </span><span class=cp>*FilterHK</span><span class=w> </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 手动选择</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- {<span class=w> </span><span class=nt>name: 🇭🇰 - 手动选择, &lt;&lt;: *Select, filter</span><span class=p>:</span><span class=w> </span><span class=cp>*FilterHK</span><span class=w> </span>}<span class=w>
</span></span></span></code></pre></div><p>其他地区相关的节点组和策略组按照如上方式编写即可，编写好之后我们就开始进行按照不同的访问目的来选择不同地区的节点，下面是编了三组，一组是节点选择，包含了自动，手动和 DIRECT；第二组是自动选择，包含所有的自动选择，以及 telegram 的节点策略组，而且默认是用香港的节点（第一个出现的即为默认）</p><p><details><summary markdown=span>proxy-groups 示例</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>proxy-groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>节点选择</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>proxies</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>自动选择, 手动选择, DIRECT]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://cp.cloudflare.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=l>https://raw.githubusercontent.com/Orz-3/mini/master/Color/Static.png</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>自动选择</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>proxies</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>🇭🇰 - 自动选择, 🇯🇵 - 自动选择, 🇰🇷 - 自动选择, 🇸🇬 - 自动选择, 🇺🇸 - 自动选择, 🇬🇧 - 自动选择, 🇫🇷 - 自动选择, 🇩🇪 - 自动选择, 🇹🇼 - 自动选择, 🇲🇾 - 自动选择, 🇹🇭 - 自动选择, 🇻🇳 - 自动选择, 🇹🇷 - 自动选择, 🇦🇷 - 自动选择]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://cp.cloudflare.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=l>https://raw.githubusercontent.com/Orz-3/mini/master/Color/Urltest.png</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Telegram</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>proxies</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>🇭🇰 - 自动选择, 🇯🇵 - 自动选择, 🇰🇷 - 自动选择, 🇸🇬 - 自动选择, 🇺🇸 - 自动选择, 🇬🇧 - 自动选择, 🇫🇷 - 自动选择, 🇩🇪 - 自动选择, 🇹🇼 - 自动选择, 🇲🇾 - 自动选择, 🇹🇭 - 自动选择, 🇻🇳 - 自动选择, 🇹🇷 - 自动选择, 🇦🇷 - 自动选择]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=l>https://raw.githubusercontent.com/Orz-3/mini/master/Color/Telegram.png</span><span class=w>
</span></span></span></code></pre></div></details></p><h3 id=分流规则>分流规则<a hidden class=anchor aria-hidden=true href=#分流规则>#</a></h3><p>讲完了基础语法，终于来到了最激动的分流规则部分了，本节的大部分规则来自于 <a href=https://github.com/SukkaW/Surge>Sukka Surge</a>，感谢 Sukka 的贡献~</p><p>首先我们得加载识别访问域名或者 IP 是否是广告的一些规则集，然后我们才能去选择策略，比如 REJECT</p><p>规则集很多配置有重复的地方，这里就先建立锚点，然后来引用锚点使得配置文件更整洁</p><p><details><summary markdown=span>规则参数</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 规则参数 [每12小时更新一次订阅规则，更新规则时使用（节点选择）策略]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RuleSet_classical</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cp>&amp;RuleSet_classical</span><span class=w> </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>classical,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>43200</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=l>text,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>proxy</span><span class=p>:</span><span class=w> </span><span class=l>节点选择,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RuleSet_domain</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cp>&amp;RuleSet_domain</span><span class=w> </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>domain,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>43200</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=l>text,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>proxy</span><span class=p>:</span><span class=w> </span><span class=l>节点选择,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RuleSet_ipcidr</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cp>&amp;RuleSet_ipcidr</span><span class=w> </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>behavior</span><span class=p>:</span><span class=w> </span><span class=l>ipcidr,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>43200</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=l>text,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>proxy</span><span class=p>:</span><span class=w> </span><span class=l>节点选择,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>}<span class=w>
</span></span></span></code></pre></div></details></p><p>然后就可以编写规则集，这里不一一列出琐碎的细节，用广告的例子来具体讲一下怎么写，读者应能举一反三</p><p><details><summary markdown=span>广告规则集</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rule-providers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reject_non_ip_no_drop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=cp>*RuleSet_classical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://ruleset.skk.moe/Clash/non_ip/reject-no-drop.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./rule_set/sukkaw_ruleset/reject_non_ip_no_drop.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reject_non_ip_drop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=cp>*RuleSet_classical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://ruleset.skk.moe/Clash/non_ip/reject-drop.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./rule_set/sukkaw_ruleset/reject_non_ip_drop.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reject_non_ip</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=cp>*RuleSet_classical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://ruleset.skk.moe/Clash/non_ip/reject.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./rule_set/sukkaw_ruleset/reject_non_ip.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reject_domainset</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=cp>*RuleSet_domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://ruleset.skk.moe/Clash/domainset/reject.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./rule_set/sukkaw_ruleset/reject_domainset.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reject_extra_domainset</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=cp>*RuleSet_domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://ruleset.skk.moe/Clash/domainset/reject_extra.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./sukkaw_ruleset/reject_domainset_extra.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reject_ip</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=cp>*RuleSet_classical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://ruleset.skk.moe/Clash/ip/reject.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./rule_set/sukkaw_ruleset/reject_ip.txt</span><span class=w>
</span></span></span></code></pre></div></details></p><p>上面的几个规则集一共有两个方面，域名和 IP 来拦截广告，我们配置分流规则务必按照域名和 IP 规则分开，而且是 IP 规则在下，从而避免不必要的 DNS 解析。下面的规则中有一个是 REJECT-DROP，跟直接 REJECT 不同的是该策略收到请求后，直接静默直到超时为止，适合那些被拒绝就立马再发起请求的情况</p><p><details><summary markdown=span>分流规则示例</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 分流规则</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 非 IP 类规则必须与 IP 类规则分开，避免不必要的 DNS 解析</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 先是拒绝类，优先级最高，引自 Sukka，包含 uBlock Origin、AdGuard、EasyList 等</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,reject_non_ip,REJECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,reject_domainset,REJECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,reject_extra_domainset,REJECT</span><span class=w> </span><span class=c># 可能开启后对性能有影响</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,reject_non_ip_drop,REJECT-DROP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,reject_non_ip_no_drop,REJECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w> </span><span class=c># 这里是另外其他的域名规则</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># IP 类规则</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,reject_ip,REJECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 兜底规则</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>MATCH,节点选择</span><span class=w>
</span></span></span></code></pre></div></details></p><p>这样就写好了一个分流规则，同时分流规则的最后应该是兜底规则，MATCH 的意思是无论什么都会去匹配</p><p>再补充一下常见的几种域名规则，方便读者自定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,ad.com,REJECT</span><span class=w> </span><span class=c># 完整的域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,google.com,auto</span><span class=w> </span><span class=c># 域名以 google.com 结尾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-KEYWORD,google,auto</span><span class=w> </span><span class=c># 域名包含关键词 google</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-REGEX,^abc.*com,PROXY</span><span class=w> </span><span class=c># 利用正则来匹配，以 abc 开头，包含 com</span><span class=w>
</span></span></span></code></pre></div><p>接着讲讲另一种规则集的常用写法，就是从上文说到的 geodata 来进行配置，也就是从 geosite 和 geoip 来匹配某种特殊用途，前者是域名，后者是 IP。这里屏蔽了 Windows 的一些脏东西，geosite 合并了 <a href=https://github.com/crazy-max/WindowsSpyBlocker>crazy-max</a> 的规则</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 引自 crazy-max 的规则，WIN-SPY 和 WIN-EXTRA 是 Windows 的附加的隐私跟踪域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># WIN-UPDATE 是 Windows 的自动更新域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,WIN-SPY,REJECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,WIN-EXTRA,REJECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,WIN-UPDATE,REJECT</span><span class=w>
</span></span></span></code></pre></div><p>但同时也要注意，当你相关规则多了之后，可能会有<strong>误杀</strong>的情况，比如如上的三条规则就导致你登不上 outlook，所以可以通过代理软件的 log 查看有哪些是必须的，然后救回来即可，不要盲目抄规则</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rule</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 引自 crazy-max 的规则，WIN-SPY 和 WIN-EXTRA 是 Windows 的附加的隐私跟踪域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># WIN-UPDATE 是 Windows 的自动更新域名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 有些域名可能被误杀，可以通过 log 来进行补救</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-REGEX,outlook.office.*.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,login.microsoftonline.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,WIN-SPY,REJECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,WIN-EXTRA,REJECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,WIN-UPDATE,REJECT</span><span class=w>
</span></span></span></code></pre></div><p>那么如果你想从 geosite 中找到自己想要的类，比如 telegram 呢？可以本地下载 geosite.dat，然后直接记事本打开，然后去搜你想要找的类别，必须要大写搜索，小写会搜到很多域名部分，geosite 中类是大写的，比如 TELEGRAM。另外，有些类是比较杂，会以 &ldquo;CATEGORY-&rdquo; 开头，可以搜搜看是否有想要的</p><p>至此你应该能够自己写配置了，接着讲一下我的配置中关于 Sukka 规则的取舍</p><ol><li>广告部分，我全部拿过来，并且启用</li><li>CDN 部分，我是专门定制了新的 CDN 节点策略组，专门用自建的节点或者低倍率节点，因为 CDN 通常流量较大</li><li>对于苹果和微软可以直连的，直接 DIRECT；不能的则分别建立苹果和微软策略组</li><li>对于流媒体部分，我并没有做过多区分，因为我也不咋用，所以就直接放到节点选择了</li><li>关于 AIGC的，我专门建立了策略组，默认是美国的节点，港澳台用不了</li><li>global 的就直接走节点选择，domestic 就走 DIRECT</li></ol><p>另外一点就是移动端如何运用覆写配置呢？我是将电脑端正在运行的配置保存为文件，然后手机导入文件即可</p><h2 id=巧用配置>巧用配置<a hidden class=anchor aria-hidden=true href=#巧用配置>#</a></h2><p>终于来到了配置的应用环节， 这里分享一些日常可以用到的配置，方便读者使用</p><h3 id=内网开梯子打不开>内网开梯子打不开<a hidden class=anchor aria-hidden=true href=#内网开梯子打不开>#</a></h3><p>很多读者发现开着梯子访问公司内网或者校园网打不开，当你读完了上文就会明白，因为当你开了系统代理之后，代理软件接管了 DNS 解析的过程，也就是说代理软件会向常用的域名服务器去查找你的公司或者校园网的域名，这当然是找不到的，内网的域名在公网肯定是解析不到的。那么就可以用到我们之前说的 nameserver-policy 来做到，当我们匹配到特定域名，就让内网的域名服务器来解析，而不是用公网的</p><p>那么如何找到内网的 nameserver 呢？找到 WiFi，然后点开属性，找到以下的即可：</p><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script>
<a data-fancybox=gallery href=https://png.yunpengtai.top/2024/12/bfe160dc1acbcdb705f5d06f82c67fd0.png><figure class=align-center><img loading=lazy src=https://png.yunpengtai.top/2024/12/bfe160dc1acbcdb705f5d06f82c67fd0.png#center width=580px height=180px></figure></a><p>然后配置好就可以开着系统代理正常访问内网了，下面说的是任何以 xxx.edu.cn 结尾的都可以走我们预设的 DNS 服务器</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;+.xxx.edu.cn&#34;: </span><span class=m>10.20.220.50</span><span class=w>
</span></span></span></code></pre></div><h3 id=解锁流媒体>解锁流媒体<a hidden class=anchor aria-hidden=true href=#解锁流媒体>#</a></h3><p>不少机场不同的节点对不同流媒体的解锁情况不一样，那么就可以将可以解锁的代理节点放在一个策略组内，然后将所有的流媒体的分流规则都导到这个策略组即可~</p><h3 id=想要直连-tracker>想要直连 tracker<a hidden class=anchor aria-hidden=true href=#想要直连-tracker>#</a></h3><p>有些读者可能像我一样日常生活中会用到一些 public 或是 private 的 tracker，有些服务器可能是国外，但是 tracker 一般都能直连，我们不想要代理去连接 tracker，就可以利用分流规则</p><p>幸好先前引入的 geosite 中有一部分是融合了<a href=https://trackerslist.com/#/zh>TrackersList</a>以及<a href=https://github.com/blackmatrix7/ios_rule_script/tree/master/rule/Clash/PrivateTracker>blackmatrix7 / ios_rule_script</a>，包含了public 和 private 的 tracker</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,CATEGORY-PUBLIC-TRACKER,DIRECT</span><span class=w> </span><span class=c># 公共 tracker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,CATEGORY-PT,DIRECT</span><span class=w> </span><span class=c># 私有 tracker</span><span class=w>
</span></span></span></code></pre></div><h3 id=使用学校学术资源>使用学校学术资源<a hidden class=anchor aria-hidden=true href=#使用学校学术资源>#</a></h3><p>有些时候开着代理软件会不可避免的用代理节点来访问学术网站，导致没办法用到学校购买的资源，下载不了论文等，此时我们就可以针对学术网站来制定一个策略组，节点配置就只有一个直连，这样就可以使得即使代理开着，也能用到学校资源</p><p>下列域名规则取自于 <a href=https://hexiao2001.github.io/2024/12/02/clash%E8%AE%A2%E9%98%85%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95/>hexiao</a>，另外注意，该域名规则应该加在 global 之前，因为优先级是从上而下的，如果一开始匹配到 global，就直接结束了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Academic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,tuchong.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,taylorandfrancis.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,dl.acm.org,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,acm-prod.disqus.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,sciencedirectassets.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,readspeaker.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,webofknowledge.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-KEYWORD,pubmed,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-KEYWORD,springer,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-KEYWORD,ieee,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-KEYWORD,elsevier,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-KEYWORD,sciencedirect,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-KEYWORD,nature,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-KEYWORD,tandfonline,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,elsevier.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,edu.cn,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,webofscience.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,tandfonline.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,link.springer.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,onlinelibrary.wiley.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,sciencedirect.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,taylorfrancis.com,DIRECT</span><span class=w>
</span></span></span></code></pre></div><h3 id=开代理访问-ipv6>开代理访问 IPv6<a hidden class=anchor aria-hidden=true href=#开代理访问-ipv6>#</a></h3><p>无论是电脑还是手机端，如果开了代理的情况下还想要访问纯 IPv6 的站点，需要开启 IPv6 相关的设置，一般来说会有总的 IPv6 开关以及 DNS 中的 IPv6 开关。这里有个误区就是你以为你的覆写文件中已经写过开启 IPv6 就可以了，实际上软件层面还要同时去打开设置</p><ul><li>电脑端的 Clash-verge-rev：设置 -> Clash 设置 -> IPv6</li><li>手机端的 FlClash：工具 -> 覆写 -> DNS -> 开启覆写 DNS 以及 IPv6；以及工具 -> 覆写 -> 基础 -> IPv6 开关</li></ul><p>需要注意的是，当你用 FlClash 开启了 DNS 覆写，那么软件中的设置项就接管了覆写配置中提前设置好的信息，就需要你手动将覆写配置中的信息输入到软件里</p><h2 id=致谢>致谢<a hidden class=anchor aria-hidden=true href=#致谢>#</a></h2><p>尽管上文均已提及本文所参考的来源，但有必要再一次列出以示感谢，排名不分先后~</p><ol><li><a href=https://blog.skk.moe/post/i-have-my-unique-surge-setup/>Sukka 关于规则集的相关配置</a></li><li><a href=https://iyyh.net/archives/3c8e34c1-1493-48bb-9359-fb5f00853500>yyhhyy 在 Mihomo party 的配置教程</a></li><li><a href=https://wiki.metacubex.one>Mihomo 官方文档</a></li><li><a href=https://github.com/MetaCubeX/meta-rules-dat>Mihomo 官方的规则 geodata 集合</a></li><li>Loyalsoldier 的 geodata 集合: <a href=https://github.com/Loyalsoldier/v2ray-rules-dat>geosite</a>和 <a href=https://github.com/Loyalsoldier/geoip>geoip</a></li><li><a href=https://github.com/VirgilClyne/GetSomeFries/wiki/%F0%9F%8C%90-ASN#%E7%AE%80%E4%BB%8B>VirgilClyne 关于 ASN 的介绍</a></li><li><a href=https://github.com/crazy-max/WindowsSpyBlocker>crazy-max 提供屏蔽 Windows 隐私以及更新的域名</a></li><li><a href=https://hexiao2001.github.io/2024/12/02/clash%E8%AE%A2%E9%98%85%E8%A7%84%E5%88%99%E6%89%A9%E5%B1%95/>学术规则来源自 hexiao 的博客</a></li><li><a href=https://github.com/Orz-3/mini>策略组的图标来自于 Orz-3</a></li><li>geodata 中的 tracker 来自于 <a href=https://trackerslist.com/>XIU2</a> 以及 <a href=https://github.com/blackmatrix7/ios_rule_script/tree/master/rule/Clash/PrivateTracker>blackmatrix7</a></li><li><a href=https://github.com/SagerNet/sing-box>Sing-Box 软件</a></li><li><a href=https://github.com/clash-verge-rev/clash-verge-rev/>Clash Verge Rev</a></li><li><a href=https://github.com/chen08209/FlClash>FlClash</a></li></ol></div><div style="margin-top:2em;padding:1em;border:0 solid;border-radius:10px;background-color:var(--code-bg)"><h3>🐱如果您想要引用，请考虑如下格式：</h3><div style=padding-top:.5em>台运鹏. (Dec. 29, 2024). 《「网络代理」这件小事》[Blog
post]. Retrieved from http://yunpengtai.top/posts/know-mihomo/</div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@online{blog-0d39e88ac5439957efa341947dc875d0,
</span></span><span class=line><span class=cl>        title={「网络代理」这件小事},
</span></span><span class=line><span class=cl>        author={Yunpeng Tai},
</span></span><span class=line><span class=cl>        year={2024},
</span></span><span class=line><span class=cl>        month={Dec},
</span></span><span class=line><span class=cl>        note={http://yunpengtai.top/posts/know-mihomo/},
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><div style=padding-bottom:.4em>自由转载-非商用-非衍生-保持署名（<a href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-SA 4.0）</a></div></div><footer class=post-footer><ul class=post-tags><li><a href=http://yunpengtai.top/tags/%E6%8A%98%E8%85%BE/>折腾</a></li><li><a href=http://yunpengtai.top/tags/%E8%87%AA%E5%AE%9A%E4%B9%89/>自定义</a></li><li><a href=http://yunpengtai.top/tags/%E4%BB%A3%E7%90%86/>代理</a></li><li><a href=http://yunpengtai.top/tags/mihomo/>Mihomo</a></li></ul><nav class=paginav><a class=next href=http://yunpengtai.top/posts/hugo-journey/><span class=title>Next »</span><br><span>Hugo PaperMod 主题精装修</span></a></nav></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/artalk@2.8.6/dist/Artalk.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/@artalk/plugin-katex@0.2.4/dist/artalk-plugin-katex.min.js></script><div id=Comments></div><script>const artalk=Artalk.init({el:"#Comments",pageKey:"",pageTitle:"「网络代理」这件小事",server:"https://comment.yunpengtai.top",site:"Tai's Blog",darkMode:"auto",versionCheck:!1});document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?artalk.setDarkMode(!1):artalk.setDarkMode(!0)})</script><script src=https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js></script>
<script>const elementCode=".mermaid",loadMermaid=function(e){mermaid.initialize({theme:e}),mermaid.init({theme:e,themeVariables:{fontFamily:["SFProText-Regular","LXGWWenKaiScreenR"]}},document.querySelectorAll(elementCode))},saveOriginalData=function(){return new Promise((e,t)=>{try{var n=document.querySelectorAll(elementCode),s=n.length;n.forEach(t=>{t.setAttribute("data-original-code",t.innerHTML),s--,s==0&&e()})}catch(e){t(e)}})},resetProcessed=function(){return new Promise((e,t)=>{try{var n=document.querySelectorAll(elementCode),s=n.length;n.forEach(t=>{t.getAttribute("data-original-code")!=null&&(t.removeAttribute("data-processed"),t.innerHTML=t.getAttribute("data-original-code")),s--,s==0&&e()})}catch(e){t(e)}})};saveOriginalData().catch(console.error);let isdark=document.body.className.includes("dark");isdark?resetProcessed().then(loadMermaid("dark")).catch(console.error):resetProcessed().then(loadMermaid("neutral")).catch(console.error),document.getElementById("theme-toggle").addEventListener("click",()=>{resetProcessed(),document.body.className.includes("dark")?loadMermaid("neutral"):loadMermaid("dark").catch(console.error)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=http://yunpengtai.top>Tai's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/sherlcok314159/MyPaperMod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("/js/pangu.min.js",function(){pangu.spacingPage()})</script><script>(function(){var e,t,n,s=document.getElementsByTagName("code");for(n=0;n<s.length;){if(t=s[n],t.parentNode.tagName!=="PRE"&&t.childElementCount===0&&(e=t.textContent,/^\$[^$]/.test(e)&&/[^$]\$$/.test(e)&&(e=e.replace(/^\$/,"\\(").replace(/\$$/,"\\)"),t.textContent=e),/^\\\((.|\s)+\\\)$/.test(e)||/^\\\[(.|\s)+\\\]$/.test(e)||/^\$(.|\s)+\$$/.test(e)||/^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(e))){t.outerHTML=t.innerHTML;continue}n++}})()</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>